---
title: "DESEq2_analyses"
author: "IP"
date: "2024-07-16"
output: html_document
---

```{r setup, include=FALSE}
load("phyloseq_object_final.RData")
library(phyloseq)
library(ape)
library(tidyverse)
library(picante)
library(ggplot2)
library(ggpubr)
library(vegan)
library(DESeq2)
library(microViz)
```

## Main function
```{r }
## !!!  Start by setting filter variables such as day and treatment groups
v_day <- c(21)
v_treat <- c("MB_Clostridia","Mb_only")
v_phyloseq_object_final <- phyloseq_object_final 
  
### FUNCTION main
## Takes in variables to filter and compare data, outputs all graphs!
deseq_main <- function(d=21,t=c("MB_Clostridia","Mb_only"),v="Treatment",physeq_object=phyloseq_object_final){
  #First process deseq and filter for significance
  deseq_results <- deseq_processing(d,t,v,physeq_object)
  deseq_results_filtered <- deseq_filtering(deseq_results)
  barplot <- deseq_barplot(d,t,v,deseq_results_filtered)
  # volcano <- deseq_volcano(d,t,v,deseq_results_filtered) ## NOT WRITTEN YET
  return(barplot)
}

deseq_main(d=v_day,t=v_treat,v="Treatment",physeq_object = phyloseq_object_final)
```

## DESEq2 processing
### Filters phyloseq object by day, treatment
### Then performs DESEq2 analysis according to variable v
```{r }
deseq_processing <- function(d=21,t=c("MB_Clostridia","Mb_only"),v="Treatment",physeq_object=phyloseq_object_final){
  #Filter the phyloseq object by input variable
  physeq_object <- ps_filter(physeq_object, day==d, Treatment%in%t)
  design_formula <- as.formula(paste("~", v))
  #Produce a deseq object and add taxa informations
  deseq_object <- phyloseq_to_deseq2(physeq_object, design_formula) %>% DESeq()
  deseq_results <- deseq_object %>% results(tidy=TRUE)
  colnames(deseq_results)[1] <- "#OTU ID"
  #Add taxa information for later.
  deseq_results <- inner_join(tax_matrix,deseq_results, by = "#OTU ID" )
  return(deseq_results)
}
```
## DESEq2 filtering
### Filters results to significance p<0.01 
```{r }
deseq_filtering <- function(deseq_results_taxa){
    ## Filter DESEq for significance p<0.01 and changes 2x or larger.
  deseq_results_sig <-  deseq_results_taxa %>%
    filter( padj<0.01 & abs(log2FoldChange)>2)
  deseq_results_sig <- deseq_results_sig[order(deseq_results_sig$log2FoldChange),]
  return(deseq_results_sig)
}
```

## Barplot function
```{r }
deseq_barplot <- function(d=21,t=c("MB_Clostridia","Mb_only"),v="Treatment",
                          desq_results=desq_results_sig) {
  g <- ggplot(data = desq_results, aes(y = reorder(Genus, -(as.numeric(log2FoldChange))), 
                                            x = log2FoldChange, fill = pvalue))+
        geom_col() + ggtitle(paste("Differential abundance at day",d,"comparing between","\n",
                                   paste(t,collapse=" & "), sep=" "))
  return(g)
}
``` 

## Volcano plot functions
```{r }
deseq_volcano <- function(d,t,v,deseq_results){
  
}
```